<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mercedes-admin后台实训项目 | 迪丽热-BUG</title>
    <meta name="description" content="学习就是一件快乐的事情">
    </ rel="icon" href="/vueblog/logo.png"><//>
    
    <link rel="preload" href="/vueblog/assets/css/0.styles.c018d73d.css" as="style"><link rel="preload" href="/vueblog/assets/js/app.3433a705.js" as="script"><link rel="preload" href="/vueblog/assets/js/2.a5f0585b.js" as="script"><link rel="preload" href="/vueblog/assets/js/56.63c9249f.js" as="script"><link rel="prefetch" href="/vueblog/assets/js/10.3de53d1a.js"><link rel="prefetch" href="/vueblog/assets/js/11.be1a7789.js"><link rel="prefetch" href="/vueblog/assets/js/12.6c8bec3b.js"><link rel="prefetch" href="/vueblog/assets/js/13.ded4d1a2.js"><link rel="prefetch" href="/vueblog/assets/js/14.50c09de7.js"><link rel="prefetch" href="/vueblog/assets/js/15.8862dc10.js"><link rel="prefetch" href="/vueblog/assets/js/16.26b64718.js"><link rel="prefetch" href="/vueblog/assets/js/17.bd8da1c9.js"><link rel="prefetch" href="/vueblog/assets/js/18.ba9b65d4.js"><link rel="prefetch" href="/vueblog/assets/js/19.7de12ee7.js"><link rel="prefetch" href="/vueblog/assets/js/20.e27fd8d6.js"><link rel="prefetch" href="/vueblog/assets/js/21.042f6261.js"><link rel="prefetch" href="/vueblog/assets/js/22.7fde2a2d.js"><link rel="prefetch" href="/vueblog/assets/js/23.feb58f7c.js"><link rel="prefetch" href="/vueblog/assets/js/24.16528e51.js"><link rel="prefetch" href="/vueblog/assets/js/25.2db8b449.js"><link rel="prefetch" href="/vueblog/assets/js/26.ba05752f.js"><link rel="prefetch" href="/vueblog/assets/js/27.83f7a5f3.js"><link rel="prefetch" href="/vueblog/assets/js/28.4da93237.js"><link rel="prefetch" href="/vueblog/assets/js/29.89732af8.js"><link rel="prefetch" href="/vueblog/assets/js/3.fbdeee26.js"><link rel="prefetch" href="/vueblog/assets/js/30.bcbdcf0a.js"><link rel="prefetch" href="/vueblog/assets/js/31.5d02021c.js"><link rel="prefetch" href="/vueblog/assets/js/32.c1d6794c.js"><link rel="prefetch" href="/vueblog/assets/js/33.bf44de95.js"><link rel="prefetch" href="/vueblog/assets/js/34.7635624f.js"><link rel="prefetch" href="/vueblog/assets/js/35.512802cd.js"><link rel="prefetch" href="/vueblog/assets/js/36.31dcdde6.js"><link rel="prefetch" href="/vueblog/assets/js/37.a1f82613.js"><link rel="prefetch" href="/vueblog/assets/js/38.d6a47501.js"><link rel="prefetch" href="/vueblog/assets/js/39.4891455d.js"><link rel="prefetch" href="/vueblog/assets/js/4.b169c448.js"><link rel="prefetch" href="/vueblog/assets/js/40.7cfd5fc4.js"><link rel="prefetch" href="/vueblog/assets/js/41.0bb24e88.js"><link rel="prefetch" href="/vueblog/assets/js/42.66ae9656.js"><link rel="prefetch" href="/vueblog/assets/js/43.adb1e858.js"><link rel="prefetch" href="/vueblog/assets/js/44.fc7ca8b6.js"><link rel="prefetch" href="/vueblog/assets/js/45.9ee964ab.js"><link rel="prefetch" href="/vueblog/assets/js/46.088c8548.js"><link rel="prefetch" href="/vueblog/assets/js/47.819d8190.js"><link rel="prefetch" href="/vueblog/assets/js/48.ad20de69.js"><link rel="prefetch" href="/vueblog/assets/js/49.6b81aed2.js"><link rel="prefetch" href="/vueblog/assets/js/5.73d16706.js"><link rel="prefetch" href="/vueblog/assets/js/50.a47eea13.js"><link rel="prefetch" href="/vueblog/assets/js/51.fada5f43.js"><link rel="prefetch" href="/vueblog/assets/js/52.5b9aadd2.js"><link rel="prefetch" href="/vueblog/assets/js/53.69272f04.js"><link rel="prefetch" href="/vueblog/assets/js/54.d8fc7474.js"><link rel="prefetch" href="/vueblog/assets/js/55.9b9ce656.js"><link rel="prefetch" href="/vueblog/assets/js/57.ac44c595.js"><link rel="prefetch" href="/vueblog/assets/js/58.4dfb9371.js"><link rel="prefetch" href="/vueblog/assets/js/59.b12f0959.js"><link rel="prefetch" href="/vueblog/assets/js/6.a04640b2.js"><link rel="prefetch" href="/vueblog/assets/js/60.cb4fe741.js"><link rel="prefetch" href="/vueblog/assets/js/61.94e6aa96.js"><link rel="prefetch" href="/vueblog/assets/js/62.eafb7bb9.js"><link rel="prefetch" href="/vueblog/assets/js/63.48634d9a.js"><link rel="prefetch" href="/vueblog/assets/js/64.5dcfdde4.js"><link rel="prefetch" href="/vueblog/assets/js/65.80f0727e.js"><link rel="prefetch" href="/vueblog/assets/js/66.c3979ec2.js"><link rel="prefetch" href="/vueblog/assets/js/67.c04d0e02.js"><link rel="prefetch" href="/vueblog/assets/js/68.bb6f2886.js"><link rel="prefetch" href="/vueblog/assets/js/69.fda887f6.js"><link rel="prefetch" href="/vueblog/assets/js/7.d73b4d12.js"><link rel="prefetch" href="/vueblog/assets/js/70.5ec50f8b.js"><link rel="prefetch" href="/vueblog/assets/js/71.a935cfa9.js"><link rel="prefetch" href="/vueblog/assets/js/8.b5c5dae4.js"><link rel="prefetch" href="/vueblog/assets/js/9.d6428a80.js">
    <link rel="stylesheet" href="/vueblog/assets/css/0.styles.c018d73d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vueblog/" class="home-link router-link-active"><!----> <span class="site-name">迪丽热-BUG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vueblog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">HTML</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vueblog/guide/html/" class="nav-link">HTML</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">JS</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vueblog/guide/js/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----> <a href="/vueblog/guide/jq/jquery/" class="nav-link">JQuery</a></li><li class="dropdown-item"><!----> <a href="/vueblog/guide/js/Gulp打包工具使用/" class="nav-link">Gulp打包工具使用</a></li><li class="dropdown-item"><!----> <a href="/vueblog/guide/js/webpack使用记录/" class="nav-link">webpack使用记录</a></li><li class="dropdown-item"><!----> <a href="/vueblog/guide/js/knex/" class="nav-link">knex常用语句</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">VUE</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vueblog/guide/vue/" class="nav-link">VUE.js</a></li><li class="dropdown-item"><!----> <a href="/vueblog/guide/element/" class="nav-link">ElementUI</a></li></ul></div></div><div class="nav-item"><a href="/vueblog/guide/weixin/" class="nav-link">微信小程序</a></div><div class="nav-item"><a href="/vueblog/guide/project/" class="nav-link router-link-active">实战项目</a></div><div class="nav-item"><a href="https://ragnar-document.github.io/QA/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  QA技术问答
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/ragnar-document" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vueblog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">HTML</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vueblog/guide/html/" class="nav-link">HTML</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">JS</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vueblog/guide/js/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----> <a href="/vueblog/guide/jq/jquery/" class="nav-link">JQuery</a></li><li class="dropdown-item"><!----> <a href="/vueblog/guide/js/Gulp打包工具使用/" class="nav-link">Gulp打包工具使用</a></li><li class="dropdown-item"><!----> <a href="/vueblog/guide/js/webpack使用记录/" class="nav-link">webpack使用记录</a></li><li class="dropdown-item"><!----> <a href="/vueblog/guide/js/knex/" class="nav-link">knex常用语句</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">VUE</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vueblog/guide/vue/" class="nav-link">VUE.js</a></li><li class="dropdown-item"><!----> <a href="/vueblog/guide/element/" class="nav-link">ElementUI</a></li></ul></div></div><div class="nav-item"><a href="/vueblog/guide/weixin/" class="nav-link">微信小程序</a></div><div class="nav-item"><a href="/vueblog/guide/project/" class="nav-link router-link-active">实战项目</a></div><div class="nav-item"><a href="https://ragnar-document.github.io/QA/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  QA技术问答
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/ragnar-document" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vueblog/guide/project/驾考.html" class="sidebar-link">驾考测试题小程序</a></li><li><a href="/vueblog/guide/project/zhihu.html" class="sidebar-link">知乎网站</a></li><li><a href="/vueblog/guide/project/ElementIMS.html" class="sidebar-link">Element IMS	实训日志</a></li><li><a href="/vueblog/guide/project/Mercedes-admin.html" class="active sidebar-link">Mercedes-admin后台实训项目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vueblog/guide/project/Mercedes-admin.html#项目介绍" class="sidebar-link">项目介绍</a></li><li class="sidebar-sub-header"><a href="/vueblog/guide/project/Mercedes-admin.html#项目主要" class="sidebar-link">项目主要</a></li><li class="sidebar-sub-header"><a href="/vueblog/guide/project/Mercedes-admin.html#第一天任务实践笔记" class="sidebar-link">第一天任务实践笔记</a></li><li class="sidebar-sub-header"><a href="/vueblog/guide/project/Mercedes-admin.html#第二天任务实践笔记" class="sidebar-link">第二天任务实践笔记</a></li><li class="sidebar-sub-header"><a href="/vueblog/guide/project/Mercedes-admin.html#第三天任务实践笔记" class="sidebar-link">第三天任务实践笔记</a></li><li class="sidebar-sub-header"><a href="/vueblog/guide/project/Mercedes-admin.html#第四天任务实践笔记" class="sidebar-link">第四天任务实践笔记</a></li><li class="sidebar-sub-header"><a href="/vueblog/guide/project/Mercedes-admin.html#结束总结" class="sidebar-link">结束总结</a></li><li class="sidebar-sub-header"><a href="/vueblog/guide/project/Mercedes-admin.html#常用代码片段" class="sidebar-link">常用代码片段</a></li><li class="sidebar-sub-header"><a href="/vueblog/guide/project/Mercedes-admin.html#组件分离管理" class="sidebar-link">组件分离管理</a></li></ul></li><li><a href="/vueblog/guide/project/LiuYinSheProject.html" class="sidebar-link">LiuYinShe</a></li><li><a href="/vueblog/guide/project/JavaScript和CSS常用工具方法封装.html" class="sidebar-link">JavaScript 和 CSS 常用工具方法封装</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mercedes-admin后台实训项目"><a href="#mercedes-admin后台实训项目" aria-hidden="true" class="header-anchor">#</a> Mercedes-admin后台实训项目</h1> <h2 id="项目介绍"><a href="#项目介绍" aria-hidden="true" class="header-anchor">#</a> 项目介绍</h2> <p>本项目为奔驰汽车的 CRM 中的销售机会信息管理。奔驰汽车和 4A 广告公司合作做出各类精良的落地页并在各个社交、媒体平台中进行投放。需要一套承接这类落地页收集回来的用户信息，并进行跟踪、统计、反馈的管理系统。通过数据反馈出，哪个落地页有效，哪个渠道获客最多，哪个销售转化最强。</p> <h2 id="项目主要"><a href="#项目主要" aria-hidden="true" class="header-anchor">#</a> 项目主要</h2> <p>使用 Node.js 的 Express 框架完成用户数据的增删改查、及角色的设置。收集落地页提交的用户信息，管理员进行分配给销售，销售对客户进行跟踪。项目主要包含以下几个模块：</p> <ol><li>前台</li> <li>落地页</li> <li>后台</li> <li>后台登录</li> <li>用户管理 1. 用户列表 2. 用户新增 3. 用户修改</li> <li>线索管理 1. 线索列表 2. 线索跟踪</li></ol> <h2 id="第一天任务实践笔记"><a href="#第一天任务实践笔记" aria-hidden="true" class="header-anchor">#</a> 第一天任务实践笔记</h2> <p>任务一： 环境搭建 主要通过 express-generator 快速搭建 Web 服务框架。</p> <p>任务二：数据库设计 主要通过产品原型设计出数据库表结构。</p> <p>任务三：使用knex 增删改查数据库</p> <hr> <h3 id="环境搭建"><a href="#环境搭建" aria-hidden="true" class="header-anchor">#</a> 环境搭建</h3> <p>环境搭建在桌面打开终端使用<code>express Mercedes-admin</code>的指令生产项目配置模版引擎</p> <p>**<a href="https://mozilla.github.io/nunjucks/cn/templating.html" target="_blank" rel="noopener noreferrer">nunjucks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>**是Mozilla开发的一个纯JavaScript编写的模板引擎，既可以用在Node环境下，又可以运行在浏览器端。</p> <p><strong>安装</strong> <code>$ npm install nunjucks</code></p> <p><strong>app.js中引入替换掉原有的模版引擎</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 引入 nunjucks</span>
<span class="token keyword">var</span> nunjucks <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nunjucks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">...</span>

<span class="token comment">// 视图模版设置</span>
<span class="token comment">// 1. 设置视图模版后缀修改为 tpl 文件</span>
<span class="token comment">// 2. 添加 nunjucks 在 express 中的自动配置</span>
<span class="token comment">// 3. 注释 设置 views 代码，在 nunjucks 自动配置中有设置</span>
<span class="token comment">// app.set('views', path.join(__dirname, 'views'));</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'tpl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
nunjucks<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  autoescape<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  express<span class="token punctuation">:</span> app<span class="token punctuation">,</span>
  watch<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>Layout.tpl</strong>模版</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{title}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    {% block css %}
    {% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    {% block content %}
    {% endblock %}

    {% block js %}
    {% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>如何使用</strong></p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>{% extends './layout.tpl' %} //继承layout 模版

{% block css %} //在对应的区域写上内容
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/stylesheets/style.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
{% endblock %}

{% block content %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>{{title}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Welcome to {{title}} with nunjucks!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

{% endblock %}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>运行项目</strong><code>npm start</code> 地址：<a href="http://localhost:3000/" target="_blank" rel="noopener noreferrer">http://localhost:3000/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="数据库的搭建"><a href="#数据库的搭建" aria-hidden="true" class="header-anchor">#</a> 数据库的搭建</h3> <p>我使用的是<a href="https://sequelpro.com/docs" target="_blank" rel="noopener noreferrer">sequelpro<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>打开软件connect进入制表</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Name:127.0.0.1
Host:127.0.0.1
Username:root
password:
DataBase:optional
Port:3306
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>点击Choose Database &gt;&gt; 选择 Add Database 创建Mercedes-admin</p> <p>建立三张表分别为clue,clue_log,user</p> <p>User:放置用户管理主要销售和管理人员的信息进行增删改查</p> <p>Clue_log:销售记录主要为销售更具分配的销售线索进行定期跟踪和记录，记录下每天和用户接触的内容、反馈和必要点</p> <p>Clue:销售线索主要为落地页提交进来的用户信息，管理员更具销售信息分配给各个销售，销售标记销售线索的状态和备注信息</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># ************************************************************</span>
<span class="token comment"># Sequel Pro SQL dump</span>
<span class="token comment"># Version 4541</span>
<span class="token comment">#</span>
<span class="token comment"># http://www.sequelpro.com/</span>
<span class="token comment"># https://github.com/sequelpro/sequelpro</span>
<span class="token comment">#</span>
<span class="token comment"># Host: 127.0.0.1 (MySQL 5.7.25)</span>
<span class="token comment"># Database: Mercedes-admin</span>
<span class="token comment"># Generation Time: 2019-07-20 04:06:54 +0000</span>
<span class="token comment"># ************************************************************</span>


<span class="token comment">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */</span><span class="token punctuation">;</span>
<span class="token comment">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */</span><span class="token punctuation">;</span>
<span class="token comment">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */</span><span class="token punctuation">;</span>
<span class="token comment">/*!40101 SET NAMES utf8 */</span><span class="token punctuation">;</span>
<span class="token comment">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */</span><span class="token punctuation">;</span>
<span class="token comment">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */</span><span class="token punctuation">;</span>
<span class="token comment">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */</span><span class="token punctuation">;</span>


<span class="token comment"># Dump of table clue</span>
<span class="token comment"># ------------------------------------------------------------</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>clue<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>clue<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>phone<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>utm<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>created_time<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>statis<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>remark<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">LOCK</span> <span class="token keyword">TABLES</span> <span class="token punctuation">`</span>clue<span class="token punctuation">`</span> <span class="token keyword">WRITE</span><span class="token punctuation">;</span>
<span class="token comment">/*!40000 ALTER TABLE `clue` DISABLE KEYS */</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>clue<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>phone<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>utm<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>created_time<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>statis<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>remark<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
	<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token string">'12'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'2019-07-19 15:42:16'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*!40000 ALTER TABLE `clue` ENABLE KEYS */</span><span class="token punctuation">;</span>
<span class="token keyword">UNLOCK</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span>


<span class="token comment"># Dump of table clue_log</span>
<span class="token comment"># ------------------------------------------------------------</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>clue_log<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>clue_log<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>clue_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>created_time<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>is_deleted<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>


<span class="token comment"># Dump of table user</span>
<span class="token comment"># ------------------------------------------------------------</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>phone<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">LOCK</span> <span class="token keyword">TABLES</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span> <span class="token keyword">WRITE</span><span class="token punctuation">;</span>
<span class="token comment">/*!40000 ALTER TABLE `user` DISABLE KEYS */</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>phone<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
	<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token string">'鹅厂大牛'</span><span class="token punctuation">,</span><span class="token number">12345678</span><span class="token punctuation">,</span><span class="token string">'12345678'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'2019-07-18 17:45:19'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token string">'123'</span><span class="token punctuation">,</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token string">'123'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'2019-07-18 17:45:19'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token string">'123'</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token string">'323123'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'2019-07-18 21:59:06'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token string">'管理'</span><span class="token punctuation">,</span><span class="token number">1234</span><span class="token punctuation">,</span><span class="token string">'12312312312'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'2019-07-19 10:54:07'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*!40000 ALTER TABLE `user` ENABLE KEYS */</span><span class="token punctuation">;</span>
<span class="token keyword">UNLOCK</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span>



<span class="token comment">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */</span><span class="token punctuation">;</span>
<span class="token comment">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */</span><span class="token punctuation">;</span>
<span class="token comment">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */</span><span class="token punctuation">;</span>
<span class="token comment">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */</span><span class="token punctuation">;</span>
<span class="token comment">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */</span><span class="token punctuation">;</span>
<span class="token comment">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div><h3 id="knex的使用"><a href="#knex的使用" aria-hidden="true" class="header-anchor">#</a> Knex的使用</h3> <p>Knex可以在Node.JS和浏览器中用作SQL查询构建器，Knex的主要目标环境是Node.js，您需要安装<code>knex</code>库，然后安装相应的数据库</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm install knex --save
npm install mysql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>初始化</strong></p> <p>该<code>knex</code>模块本身就是一个函数，它接受Knex的配置对象，接受一些参数。该<code>client</code>参数是必需的，用于确定将与库一起使用的客户端适配器</p> <p>根目录下新建config.js</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> configs <span class="token operator">=</span> <span class="token punctuation">{</span>
    mysql<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      host<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
      port<span class="token punctuation">:</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
      user<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      password<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      database<span class="token punctuation">:</span> <span class="token string">'Mercedes-admin'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> configs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>新建model/knex.js</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 引用配置文件</span>
<span class="token keyword">const</span> configs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 把配置文件中的信息，设置在初始化配置中</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'knex'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  client<span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
  connection<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>host<span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>port<span class="token punctuation">,</span>
    user<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>user<span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> configs<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>database
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="第二天任务实践笔记"><a href="#第二天任务实践笔记" aria-hidden="true" class="header-anchor">#</a> 第二天任务实践笔记</h2> <p>任务四：模版配置 主要通过 Nunjucks 和 router 配置生成各个页面及访问路径。</p> <p>任务五：页面样式 主要通过 HTML 、CSS 完成所有页面的结构与样式。</p> <p>任务六：用户管理 主要通过 knex.js 连接 MySQL 实现用户数据的增删改查。</p> <hr> <h3 id="模版配置"><a href="#模版配置" aria-hidden="true" class="header-anchor">#</a> 模版配置</h3> <p>修改routes下原有的user.js文件为api.js,同时需要在app.js中把原有的导入和使用修改</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> apiRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/api'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span><span class="token punctuation">.</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> apiRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Index.js主要放置页面路由</p> <p>以下列举格式</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>roter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/页面地址'</span><span class="token function">，fucntion</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/user'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="配置页面样式结构"><a href="#配置页面样式结构" aria-hidden="true" class="header-anchor">#</a> 配置页面样式结构</h3> <p>新建以下页面文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>view
	-admin
		-login.tpl
		-user.tpl
		-clue.tpl
		-clue_log.tpl
		-user_created.tpl
		-user_edit.tpl
	-index.tpl
	-layout.tpl
	-error.tpl
	-admin_layout.tpl
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>配置好的页面 <a href="https://github.com/ragnar-document/Mercedes-admin/tree/master/views" target="_blank" rel="noopener noreferrer">https://github.com/ragnar-document/Mercedes-admin/tree/master/views<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>页面的数据通过routes/index.js发送</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/user.tpl'</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>locals<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>方法render(view, model)接受两个参数第一个放置视图，model放置数据，在JavaScript中，它就是一个简单的Object。<code>render</code>函数返回一个字符串，就是模板的输出。</p> <h3 id="用户管理"><a href="#用户管理" aria-hidden="true" class="header-anchor">#</a> 用户管理</h3> <p>在models文件中放置knex文件在第一天配置数据库时顺便先给配置上了</p> <p><strong>文件结构</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>models
	- knex.js
	- base.js		//配置查询器
	- user.js		//定义用户模型并基础基础模型/定义参数默认值
	-	clue.js
	-	log.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>Base对数据库查询方法进行封装</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//使用knex</span>
<span class="token keyword">const</span> knex <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./knex.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//构造类函数</span>
<span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//接收一个函数props</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>table <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">//设置表</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">knex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>table<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建select查询，获取查询的可选列数组，如果在构建查询时没有指定列，则默认为*。select调用的响应将使用从数据库中选择的对象数组解析。</span>
<span class="token punctuation">}</span>

<span class="token function">select</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">knex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>table<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//接收params的数据查询数据库中对应的数据</span>
<span class="token punctuation">}</span>

<span class="token function">insert</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">knex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>table<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建一个插入查询，将要插入到行中的属性的哈希值或插入数组作为单个插入命令执行。</span>
<span class="token punctuation">}</span>

<span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span>params</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">knex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>table<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//查询是否是对应id内容是就更新</span>
  <span class="token comment">//创建更新查询，根据其他查询约束更新属性哈希值或键/值对。如果传递返回的数组，例如['id'，'title']，则它会解析promise /使用包含指定列的所有更新行的数组来完成回调。</span>
<span class="token punctuation">}</span>

<span class="token keyword">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">knex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>table<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">//此方法根据查询中指定的其他条件删除一行或多行。</span>
<span class="token punctuation">}</span>

<span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">knex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>table<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">conunt</span><span class="token punctuation">(</span><span class="token string">'id as sum'</span><span class="token punctuation">)</span>
  <span class="token comment">//输出</span>
  <span class="token comment">//select count(`id`) as `sum` from `this.table`</span>
<span class="token punctuation">}</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Base 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p><strong>基础格式</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 引用基础模型</span>
<span class="token keyword">const</span> Base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./base.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义用户模型并基础基础模型</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token comment">// 定义参数默认值为 users 表</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props <span class="token operator">=</span> <span class="token string">'user'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="第三天任务实践笔记"><a href="#第三天任务实践笔记" aria-hidden="true" class="header-anchor">#</a> 第三天任务实践笔记</h2> <p>任务七：登录与退出 主要通过 cookie 实现用户登录状态的管理。</p> <p>任务八：线索记录 主要通过落地页发送的用户数据在线索管理列表中展示。</p> <hr> <h3 id="登录与退出"><a href="#登录与退出" aria-hidden="true" class="header-anchor">#</a> 登录与退出</h3> <p>新建加密文件utils/authCode.js用于cookie的加密和解密注意不要吧算法文件上传</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/**
 * 加密解密
 */</span>

<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> key <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'jikexueyuan#$123'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> iv <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'FnJL7EDzjqWjcaY9'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">authcode</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span> operation</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//没有就解密有就加密</span>
    operation <span class="token operator">?</span> operation <span class="token punctuation">:</span> <span class="token string">'DECODE'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>operation <span class="token operator">==</span> <span class="token string">'DECODE'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> src <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> cipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDecipheriv</span><span class="token punctuation">(</span><span class="token string">'aes-128-cbc'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        src <span class="token operator">+=</span> cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        src <span class="token operator">+=</span> cipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> sign <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> cipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createCipheriv</span><span class="token punctuation">(</span><span class="token string">'aes-128-cbc'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sign <span class="token operator">+=</span> cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sign <span class="token operator">+=</span> cipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sign<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> authcode<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>在api.js需要调用登陆权限的方法和页面渲染规则判断输入的用户和密码是否与数据一致</p> <p>通过调用models层的user.js使用查找数据对比数据是否一致</p> <p>通过调用加密算法判断是否加密或解密</p> <p>新建/controllers/auth.js</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./../models/user.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> authCodeFunc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./../utils/authCod.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> authController <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">login</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> phone <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>phone<span class="token punctuation">;</span>
    <span class="token keyword">let</span> password <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>phone <span class="token operator">||</span> <span class="token operator">!</span>password<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请填写完整信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span> 
    
  	<span class="token keyword">try</span><span class="token punctuation">{</span>
     <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">{</span>phoen<span class="token punctuation">,</span>password<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
     <span class="token keyword">const</span> user <span class="token operator">=</span> users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token comment">//组合加密</span>
       <span class="token keyword">let</span> auth_Code <span class="token operator">=</span> phone <span class="token operator">+</span><span class="token string">'\t'</span> <span class="token operator">+</span> password <span class="token operator">+</span><span class="token string">'\t'</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">'\t'</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>role<span class="token punctuation">;</span>
       auth_Code <span class="token operator">=</span> <span class="token function">authCodeFunc</span><span class="token punctuation">(</span>auth_Code<span class="token punctuation">,</span><span class="token string">'ENCODE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//加密繁殖在cookie中</span>
       res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'ac'</span><span class="token punctuation">,</span>auth_Code<span class="token punctuation">,</span> <span class="token punctuation">{</span> maxAge<span class="token punctuation">:</span> <span class="token number">24</span><span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
         code<span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">,</span>
         message<span class="token punctuation">:</span><span class="token string">'登陆成功'</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
       res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
         code<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>
         
         message<span class="token punctuation">:</span><span class="token string">'没有该用户'</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        code<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>
        message<span class="token punctuation">:</span><span class="token string">'系统问题'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 渲染登录页面的模版</span>
  <span class="token function-variable function">renderLogin</span><span class="token punctuation">:</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 如果用户已经登录，重定向到用户管理页面</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>isLogin<span class="token punctuation">)</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/admin/clue'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/login'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>需要在routes/api.js中引入Login方法</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> authController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./../controllers/auth.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">...</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span> <span class="token punctuation">,</span> authController<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在routes/index.js中引入渲染的方法</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> authController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./../controllers/auth.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">...</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/login'</span><span class="token punctuation">,</span> authController<span class="token punctuation">.</span>renderLogin<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="为login页也写上js脚本发送ajax请求"><a href="#为login页也写上js脚本发送ajax请求" aria-hidden="true" class="header-anchor">#</a> 为Login页也写上js脚本发送ajax请求</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">PAGE</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  init<span class="token punctuation">:</span><span class="token function">funciton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
  bind<span class="token punctuation">:</span><span class="token function">funciton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#userSumbit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleSumbit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  handleSumbit<span class="token punctuation">:</span><span class="token function">funciton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> phone <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#userPhone'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> password <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#userPassword'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>phone <span class="token operator">||</span> <span class="token operator">!</span>paswword<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">alert</span><span class="token punctuation">(</span>'缺少参数‘）<span class="token keyword">return</span><span class="token punctuation">}</span>
		$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    	url<span class="token punctuation">:</span><span class="token string">'api/login'</span><span class="token punctuation">,</span>
			data<span class="token punctuation">:</span><span class="token punctuation">{</span>phone<span class="token punctuation">,</span>password<span class="token punctuation">}</span><span class="token punctuation">,</span>
      type<span class="token punctuation">:</span><span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">beforeSend</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//禁止节点</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#userSubmit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'登录成功！'</span><span class="token punctuation">)</span>
          location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'/admin/user'</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">error</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">complete</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#userSubmit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token constant">PAGE</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>新建过滤中间件，filters/index.js，filters/loginFilter.js，filters/initFilter.js。filters/index.js 为主文件分别引用 filters/loginFilter.js 及 filters/initFilter.js，分别用于设置用户信息和全局信息。</p> <p>文件参考：<a href="https://github.com/ragnar-document/Mercedes-admin/tree/master/filters" target="_blank" rel="noopener noreferrer">https://github.com/ragnar-document/Mercedes-admin/tree/master/filters<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>在启动文件 app.js 中引用文件中引用 filters ，要在定义路由之前定义。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> filters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./filters/index'</span><span class="token punctuation">)</span>

<span class="token operator">...</span>

<span class="token function">filters</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> indexRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> apiRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>新建用户中间件，并设置判断是否登录的方法</p> <p><strong>Middleware/auth.js</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> authMiddleware <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">mustLogin</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>isLogin<span class="token punctuation">)</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/admin/login'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> authMiddleware<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在用户管理页面相关路由中引入</p> <h3 id="线索记录"><a href="#线索记录" aria-hidden="true" class="header-anchor">#</a> 线索记录</h3> <p>实现过程需要重数据库拿到数据进行渲染所有需要先创建models层的clue继承base的方法，在controller</p> <p>建立展示页面的逻辑，然后在api和index添加controller中创建的方法</p> <p>创建clue的model</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./knex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Clue</span> <span class="token keyword">extends</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props <span class="token operator">=</span> <span class="token string">'clue'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Clue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>创建线索 controller ,并完善其添加和线索列表页面展示的逻辑</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Clue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./../models/clue.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> formatTime <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./../utils/date.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> userController <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">insert</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	<span class="token keyword">let</span> phone <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>phone<span class="token punctuation">;</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token keyword">let</span> utm <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>utm<span class="token punctuation">;</span>
    <span class="token keyword">let</span> created_time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token operator">||</span><span class="token operator">!</span>phone<span class="token punctuation">)</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        code<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>
        message<span class="token punctuation">:</span><span class="token string">'缺少参数'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">try</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> clues <span class="token operator">=</span> <span class="token keyword">await</span> Clue<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        phone<span class="token punctuation">,</span>name<span class="token punctuation">,</span>utm<span class="token punctuation">,</span>created_time
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        code<span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span>clues
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        code<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>
        message<span class="token punctuation">:</span><span class="token string">'内部问题'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">show</span><span class="token punctuation">:</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> clues <span class="token operator">=</span> <span class="token keyword">await</span> Clue<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>clues <span class="token operator">=</span> clues<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>	<span class="token comment">//渲染模版需要的数据</span>
        data<span class="token punctuation">.</span>created_time_display <span class="token operator">=</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>created_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> data
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
     res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/clue.tpl'</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>locals<span class="token punctuation">)</span><span class="token comment">//渲染clue页</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>error <span class="token operator">=</span> e<span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>locals<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Clue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p><strong>/views/index.tpl</strong> 中引入**/public/javascripts/index.js**</p> <p><a href="https://github.com/ragnar-document/Mercedes-admin/blob/master/public/javascripts/index.js" target="_blank" rel="noopener noreferrer">https://github.com/ragnar-document/Mercedes-admin/blob/master/public/javascripts/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>配置线索列表模版</p> <p><a href="https://github.com/ragnar-document/Mercedes-admin/blob/master/views/admin/clue.tpl" target="_blank" rel="noopener noreferrer">https://github.com/ragnar-document/Mercedes-admin/blob/master/views/admin/clue.tpl<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="第四天任务实践笔记"><a href="#第四天任务实践笔记" aria-hidden="true" class="header-anchor">#</a> 第四天任务实践笔记</h2> <p>任务九：线索跟踪 主要通过对应的线索信息进行编辑和提交记录信息。</p> <p>任务十：销售展示 主要通过权限的区分为管理员与销售展示不同的内容。</p> <hr> <h3 id="线索跟踪"><a href="#线索跟踪" aria-hidden="true" class="header-anchor">#</a> 线索跟踪</h3> <p>在线索列表页中每一条记录都有跟踪按钮对信息进行记录和更改，点击时跳到对应id编辑页，在clue_log中获取到页面ID通过knex查询表对应ID的用户信息对页面作出渲染。信息编辑通过获取更改的数据判断是否有修改值通过ajax请求put到数据表中添加信息则是通过post</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token function-variable function">log</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
      <span class="token comment">//获取页面id</span>
      <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
      <span class="token keyword">const</span> clues <span class="token operator">=</span> <span class="token keyword">await</span> Clue<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">//获取表中信息</span>
      <span class="token keyword">const</span> logs <span class="token operator">=</span> <span class="token keyword">await</span> ClueLog<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">{</span> clue_id <span class="token punctuation">:</span> id<span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">//获取管理员列表</span>
      <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">{</span> role<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">//保存到res.locals</span>
      res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>users <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          id<span class="token punctuation">:</span> data<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
          name<span class="token punctuation">:</span> data<span class="token punctuation">.</span>name
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//把获取到的数据存入locals中</span>
      res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>clue <span class="token operator">=</span> clues<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>clue<span class="token punctuation">.</span>created_time_display <span class="token operator">=</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>clue<span class="token punctuation">.</span>created_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>logs <span class="token operator">=</span> logs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>created_time_display <span class="token operator">=</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>created_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> data
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//渲染到页面中</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/clue_log.tpl'</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>locals<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>error <span class="token operator">=</span> e<span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>locals<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>获取页面ID  &gt;&gt;  通过id获取表中信息  &gt;&gt;  把获得的信息存入locals中 &gt;&gt;  发送渲染到页面</p> <p>把页面渲染出来后接着就做页面逻辑</p> <p>通过点击按键获取修改的内容接着判断是否缺少参数如何通过ajax发送请求</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token punctuation">:</span> <span class="token string">'/api/clue/'</span> <span class="token operator">+</span> id<span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span> remark<span class="token punctuation">,</span> status<span class="token punctuation">,</span> user_id <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//发送修改的数据</span>
    type<span class="token punctuation">:</span> <span class="token string">'PUT'</span><span class="token punctuation">,</span>	<span class="token comment">//通过put请求</span>
    <span class="token function-variable function">beforeSend</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">//点击完关上按钮</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#clueSubmit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//成功后的反应</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'编辑成功！'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">error</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">//失败后的反应</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">complete</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">//响应结束后打开按钮</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#clueSubmit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>同样添加数据也是相似的使用post请求发送数据，添加成功后使用 location.reload();刷新页面</p> <p><strong>接下来是在api.js中请求数据库</strong></p> <p>获取请求体中的数据判断是否获取到值，通过trycatch捕获成功和失败的值返回一个状态码</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">update</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> status <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>status<span class="token punctuation">;</span>    
    <span class="token keyword">let</span> remark <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>remark<span class="token punctuation">;</span>
    <span class="token keyword">let</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">let</span> user_id <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>status <span class="token operator">||</span> <span class="token operator">!</span>remark<span class="token punctuation">)</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token string">'缺少必要参数'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> clue <span class="token operator">=</span> <span class="token keyword">await</span> Clue<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span> id <span class="token punctuation">,</span><span class="token punctuation">{</span> 
        status<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>remark
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
        code<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> 
        data<span class="token punctuation">:</span> clue
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
        code<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        message<span class="token punctuation">:</span> <span class="token string">'内部错误'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
  <span class="token function-variable function">addLog</span><span class="token punctuation">:</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> content <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token keyword">let</span> created_time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> clue_id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>

    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        code<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>
        message<span class="token punctuation">:</span><span class="token string">'缺少参数'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> clue <span class="token operator">=</span> <span class="token keyword">await</span> ClueLog<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        content<span class="token punctuation">,</span>created_time<span class="token punctuation">,</span>clue_id
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        code<span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span>clue
      <span class="token punctuation">}</span><span class="token punctuation">)</span>  
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>code<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>message<span class="token punctuation">:</span><span class="token string">'内部错误'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h3 id="销售展示"><a href="#销售展示" aria-hidden="true" class="header-anchor">#</a> 销售展示</h3> <p>由于销售和线索是分开两张表所以需要连表查询</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>加入 -.join(table, first, [operator], second)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>连接构建器可用于指定表之间的连接，第一个参数是连接表，后三个参数分别是第一个连接列，连接操作符和第二个连接列。</p> <p><strong>实例</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">knex</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'contacts'</span><span class="token punctuation">,</span> <span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">,</span> <span class="token string">'contacts.user_id'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'contacts.phone'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>models/Clue.js</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Clue</span> <span class="token keyword">extends</span> <span class="token class-name">Base</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props <span class="token operator">=</span> <span class="token string">'clue'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">//声明一个方法同时接收参数</span>
  <span class="token function">joinUser</span><span class="token punctuation">(</span><span class="token parameter">params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">knex</span><span class="token punctuation">(</span><span class="token string">'clue'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span><span class="token string">'clue.user_id'</span><span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">,</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
      <span class="token string">'clue.id'</span><span class="token punctuation">,</span>
      <span class="token string">'clue.name'</span><span class="token punctuation">,</span>
      <span class="token string">'clue.phone'</span><span class="token punctuation">,</span>
      <span class="token string">'clue.utm'</span><span class="token punctuation">,</span>
      <span class="token string">'clue.status'</span><span class="token punctuation">,</span>
      <span class="token string">'clue.created_time'</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token string">'sales_name'</span><span class="token punctuation">:</span><span class="token string">'user.name'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>Routes/index.js</p> <p>连接好表以后需要到渲染页面的index文件中使用clue中的方法进行取值</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token function-variable function">show</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
      <span class="token comment">// const clues = await Clue.all();</span>
      <span class="token keyword">const</span> role <span class="token operator">=</span> res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>role<span class="token punctuation">;</span>
      <span class="token keyword">const</span> user_id <span class="token operator">=</span> res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
      <span class="token comment">// console.log(role,user_id);</span>
      <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token comment">//判断是否是管理人员如果是就传入到params中</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>role <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        params<span class="token punctuation">.</span>user_id <span class="token operator">=</span> user_id
      <span class="token punctuation">}</span>
      
      <span class="token comment">//通过获取到的用户id传入到model层进行查询取值</span>
      <span class="token keyword">const</span> clues <span class="token operator">=</span> <span class="token keyword">await</span> Clue<span class="token punctuation">.</span><span class="token function">joinUser</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>clues<span class="token punctuation">)</span>
      <span class="token comment">//map循环取到的值返回一个新数组存入res.locals中</span>
      
      res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>clues <span class="token operator">=</span> clues<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>created_time_display <span class="token operator">=</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>created_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// console.log(data)</span>
        <span class="token keyword">return</span> data
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/clue.tpl'</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>locals<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>error <span class="token operator">=</span> e<span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>locals<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="结束总结"><a href="#结束总结" aria-hidden="true" class="header-anchor">#</a> 结束总结</h2> <p>数据库类型需要设置好否则无法插入值会报错，使用knex连接数据使用通过base文件设置公共样式文件，因为未做分离所以代码看上去显得非常臃肿不美观难以维护，在下次修改对应用层controller进行分离。一般问题都处在传值上面出问题</p> <h2 id="常用代码片段"><a href="#常用代码片段" aria-hidden="true" class="header-anchor">#</a> 常用代码片段</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      url<span class="token punctuation">:</span><span class="token string">'/地址'</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span> 传入数据 <span class="token punctuation">}</span><span class="token punctuation">,</span>
      type<span class="token punctuation">:</span> <span class="token string">'POST，PUT,DELETE，GET....等'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">beforeSend</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#logSubmit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'添加成功！'</span><span class="token punctuation">)</span>
          <span class="token comment">//添加后重新加载网页</span>
          location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">error</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">complete</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#logSubmit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="组件分离管理"><a href="#组件分离管理" aria-hidden="true" class="header-anchor">#</a> 组件分离管理</h2> <p>按照分类我们需要把卸载router/index和api中的方法抽离到一个专门的文件controllers文件中进行调用使用</p> <p>因为方法中都使用到model层的查询方法所以需要注意调用，把登陆管理的放在中间件文件单独存放</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/vueblog/guide/project/ElementIMS.html" class="prev">
          Element IMS	实训日志
        </a></span> <span class="next"><a href="/vueblog/guide/project/LiuYinSheProject.html">
          LiuYinShe
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/vueblog/assets/js/app.3433a705.js" defer></script><script src="/vueblog/assets/js/2.a5f0585b.js" defer></script><script src="/vueblog/assets/js/56.63c9249f.js" defer></script>
  </body>
</html>
